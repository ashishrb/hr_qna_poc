<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Analytics Dashboard - Employee 360° View</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <span>HR Analytics</span>
            </div>
            <div class="status-badge">
                <div class="status-dot"></div>
                <span>Live</span>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <a href="#dashboard" class="nav-item active" data-section="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            <a href="#query" class="nav-item" data-section="query">
                <i class="fas fa-search"></i>
                <span>AI Query</span>
            </a>
            <a href="#analytics" class="nav-item" data-section="analytics">
                <i class="fas fa-chart-bar"></i>
                <span>Analytics</span>
            </a>
            <a href="#advanced-analytics" class="nav-item" data-section="advanced-analytics">
                <i class="fas fa-brain"></i>
                <span>AI Analytics</span>
            </a>
            <a href="#employees" class="nav-item" data-section="employees">
                <i class="fas fa-users"></i>
                <span>Employees</span>
            </a>
            <a href="#reports" class="nav-item" data-section="reports">
                <i class="fas fa-file-alt"></i>
                <span>Reports</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-details">
                    <span class="user-name">HR Admin</span>
                    <span class="user-role">Administrator</span>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Header -->
        <header class="top-header">
            <div class="header-left">
                <h1 class="page-title" id="pageTitle">Dashboard Overview</h1>
                <p class="page-subtitle" id="pageSubtitle">Comprehensive employee analytics and insights</p>
            </div>
            <div class="header-right">
                <div class="header-actions">
                    <button class="btn btn-outline">
                        <i class="fas fa-download"></i>
                        Export
                    </button>
                    <button class="btn btn-primary" onclick="showAddEmployeeModal()">
                        <i class="fas fa-plus"></i>
                        Add Employee
                    </button>
                </div>
                <div class="notification-bell">
                    <i class="fas fa-bell"></i>
                    <span class="notification-count">3</span>
                </div>
            </div>
        </header>

        <!-- Dashboard Section -->
        <section id="dashboard" class="content-section active">
            <!-- Key Metrics Cards -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="metric-content">
                        <h3 class="metric-value" id="totalEmployees">25</h3>
                        <p class="metric-label">Total Employees</p>
                        <div class="metric-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>+12% from last month</span>
                        </div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="fas fa-building"></i>
                    </div>
                    <div class="metric-content">
                        <h3 class="metric-value" id="totalDepartments">8</h3>
                        <p class="metric-label">Departments</p>
                        <div class="metric-change neutral">
                            <i class="fas fa-minus"></i>
                            <span>No change</span>
                        </div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="metric-content">
                        <h3 class="metric-value" id="avgPerformance">3.8</h3>
                        <p class="metric-label">Avg Performance</p>
                        <div class="metric-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>+0.2 from last quarter</span>
                        </div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="metric-content">
                        <h3 class="metric-value" id="attritionRisk">11</h3>
                        <p class="metric-label">At Risk</p>
                        <div class="metric-change negative">
                            <i class="fas fa-arrow-up"></i>
                            <span>+3 this month</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts and Analytics -->
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Department Distribution</h3>
                        <div class="chart-actions">
                            <button class="btn-icon">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-content">
                        <div class="chart-placeholder">
                            <i class="fas fa-chart-pie"></i>
                            <p>Department breakdown visualization</p>
                        </div>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Performance Trends</h3>
                        <div class="chart-actions">
                            <button class="btn-icon">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-content">
                        <div class="chart-placeholder">
                            <i class="fas fa-chart-line"></i>
                            <p>Performance over time</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h3>Quick Actions</h3>
                <div class="actions-grid">
                    <button class="action-card" data-section="query">
                        <i class="fas fa-search"></i>
                        <span>Ask AI Question</span>
                    </button>
                    <button class="action-card" data-section="analytics">
                        <i class="fas fa-chart-bar"></i>
                        <span>View Analytics</span>
                    </button>
                    <button class="action-card" data-section="employees">
                        <i class="fas fa-users"></i>
                        <span>Browse Employees</span>
                    </button>
                    <button class="action-card">
                        <i class="fas fa-file-export"></i>
                        <span>Generate Report</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- AI Query Section -->
        <section id="query" class="content-section">
            <div class="query-container">
                <div class="query-header">
                    <h2>AI-Powered HR Query</h2>
                    <p>Ask questions about your employees in natural language</p>
                </div>
                
                <div class="query-input-container">
                    <div class="query-input-wrapper">
                        <textarea 
                            id="queryInput" 
                            placeholder="Ask anything about your employees... (e.g., 'Show me top performers', 'What is the average salary?', 'How many employees in Marketing?')"
                            rows="3"
                        ></textarea>
                        <button class="query-submit-btn" onclick="submitQuery()">
                            <i class="fas fa-paper-plane"></i>
                            Ask
                        </button>
                    </div>
                    
                    <div class="query-examples">
                        <h4>Try these examples:</h4>
                        <div class="example-tags">
                            <span class="example-tag" onclick="setQuery('How many employees work in Marketing department?')">Count Marketing employees</span>
                            <span class="example-tag" onclick="setQuery('Show me top 5 performers')">Top performers</span>
                            <span class="example-tag" onclick="setQuery('What is the average salary across all departments?')">Average salary</span>
                            <span class="example-tag" onclick="setQuery('Which employees have high attrition risk?')">Attrition risk</span>
                            <span class="example-tag" onclick="setQuery('What is the average performance rating?')">Performance analytics</span>
                            <span class="example-tag" onclick="setQuery('Show me employees with highest KPIs')">High KPIs</span>
                            <span class="example-tag" onclick="setQuery('Compare performance between IT and Marketing')">Department comparison</span>
                            <span class="example-tag" onclick="setQuery('Who are the newest employees?')">Recent hires</span>
                            <span class="example-tag" onclick="setQuery('What is the gender distribution?')">Gender analytics</span>
                            <span class="example-tag" onclick="setQuery('Show me employees earning above $100,000')">High earners</span>
                        </div>
                    </div>
                </div>
                
                <div class="query-results" id="queryResults">
                    <div class="results-placeholder">
                        <i class="fas fa-lightbulb"></i>
                        <p>Your AI-powered insights will appear here</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Analytics Section -->
        <section id="analytics" class="content-section">
            <div class="analytics-container">
                <div class="analytics-header">
                    <h2>Advanced Analytics</h2>
                    <p>Deep insights into your workforce data</p>
                </div>
                
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <h3>Department Analytics</h3>
                        <p>Distribution and trends across departments</p>
                        <button class="btn btn-outline">View Details</button>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <h3>Performance Analytics</h3>
                        <p>Employee performance metrics and trends</p>
                        <button class="btn btn-outline">View Details</button>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <h3>Compensation Analytics</h3>
                        <p>Salary analysis and budget insights</p>
                        <button class="btn btn-outline">View Details</button>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3>Attrition Analytics</h3>
                        <p>Risk assessment and retention insights</p>
                        <button class="btn btn-outline">View Details</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- AI Analytics Section -->
        <section id="advanced-analytics" class="content-section">
            <div class="analytics-container">
                <div class="analytics-header">
                    <h2>AI-Powered Analytics</h2>
                    <p>Advanced AI agents providing intelligent workforce insights</p>
                </div>
                
                <div id="analyticsContent">
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading AI Analytics...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Employees Section -->
        <section id="employees" class="content-section">
            <div class="employees-container">
                <div class="employees-header">
                    <h2>Employee Directory</h2>
                    <div class="employees-actions">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Search employees..." id="employeeSearch">
                        </div>
                        <button class="btn btn-primary" onclick="showAddEmployeeModal()">
                            <i class="fas fa-plus"></i>
                            Add Employee
                        </button>
                    </div>
                </div>
                
                <div class="employees-grid" id="employeesGrid">
                    <div class="employee-card">
                        <div class="employee-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="employee-info">
                            <h4>David Wilson</h4>
                            <p>Marketing Manager</p>
                            <span class="employee-department">Marketing</span>
                        </div>
                        <div class="employee-actions">
                            <button class="btn-icon">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="employee-card">
                        <div class="employee-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="employee-info">
                            <h4>Rachel Wright</h4>
                            <p>DevOps Engineer</p>
                            <span class="employee-department">IT</span>
                        </div>
                        <div class="employee-actions">
                            <button class="btn-icon">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="employee-card">
                        <div class="employee-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="employee-info">
                            <h4>Michelle Lewis</h4>
                            <p>Tech Lead</p>
                            <span class="employee-department">IT</span>
                        </div>
                        <div class="employee-actions">
                            <button class="btn-icon">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Reports Section -->
        <section id="reports" class="content-section">
            <div class="reports-container">
                <div class="reports-header">
                    <h2>Reports & Documents</h2>
                    <p>Generate and download comprehensive HR reports</p>
                </div>
                
                <div class="reports-grid">
                    <div class="report-card">
                        <div class="report-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <h3>Employee Summary</h3>
                        <p>Complete employee overview report</p>
                        <button class="btn btn-primary" onclick="generateReport('employee-summary')">Generate</button>
                    </div>
                    
                    <div class="report-card">
                        <div class="report-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <h3>Performance Report</h3>
                        <p>Performance metrics and analysis</p>
                        <button class="btn btn-primary" onclick="generateReport('performance')">Generate</button>
                    </div>
                    
                    <div class="report-card">
                        <div class="report-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <h3>Compensation Report</h3>
                        <p>Salary and benefits analysis</p>
                        <button class="btn btn-primary" onclick="generateReport('compensation')">Generate</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner-container">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <div class="loading-content">
                <h3 id="loadingTitle">Processing your request...</h3>
                <p id="loadingMessage">Please wait while we analyze your data</p>
                <div class="loading-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <span class="progress-text" id="progressText">0%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <div id="addEmployeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Employee</h2>
                <span class="close" onclick="closeAddEmployeeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addEmployeeForm">
                    <div class="form-group">
                        <label for="full_name">Full Name *</label>
                        <input type="text" id="full_name" name="full_name" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email *</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="department">Department *</label>
                        <select id="department" name="department" required>
                            <option value="">Select Department</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Customer Success">Customer Success</option>
                            <option value="Engineering">Engineering</option>
                            <option value="Sales">Sales</option>
                            <option value="HR">HR</option>
                            <option value="Finance">Finance</option>
                            <option value="IT">IT</option>
                            <option value="Operations">Operations</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="role">Role *</label>
                        <input type="text" id="role" name="role" required>
                    </div>
                    <div class="form-group">
                        <label for="current_salary">Current Salary</label>
                        <input type="number" id="current_salary" name="current_salary" min="0">
                    </div>
                    <div class="form-group">
                        <label for="age">Age</label>
                        <input type="number" id="age" name="age" min="18" max="100">
                    </div>
                    <div class="form-group">
                        <label for="location">Location</label>
                        <input type="text" id="location" name="location">
                    </div>
                    <div class="form-group">
                        <label for="contact_number">Contact Number</label>
                        <input type="tel" id="contact_number" name="contact_number">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-outline" onclick="closeAddEmployeeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Employee</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/static/script.js"></script>
    
    <!-- Simple Navigation Script -->
    <script>
        // Simple navigation function that works independently
        function simpleShowSection(sectionName) {
            console.log('Simple navigation to:', sectionName);
            
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionName);
            if (targetSection) {
                targetSection.classList.add('active');
                console.log('Section activated:', sectionName);
                
                // Update navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const activeNav = document.querySelector(`[data-section="${sectionName}"]`);
                if (activeNav) {
                    activeNav.classList.add('active');
                    console.log('Navigation updated for:', sectionName);
                }
                
                // Load section data if dashboard is available
                if (window.dashboard && window.dashboard.loadSectionData) {
                    console.log('Loading data for section:', sectionName);
                    window.dashboard.loadSectionData(sectionName);
                } else {
                    console.log('Dashboard not available for data loading');
                    
                    // Direct data loading for specific sections
                    if (sectionName === 'employees') {
                        setTimeout(() => {
                            window.loadEmployeesDirect();
                        }, 100);
                    } else if (sectionName === 'advanced-analytics') {
                        setTimeout(() => {
                            window.loadAdvancedAnalyticsDirect();
                        }, 100);
                    }
                }
            } else {
                console.error('Section not found:', sectionName);
            }
        }
        
        // Override the showSection function
        window.showSection = simpleShowSection;
        
        // Test navigation on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, testing navigation...');
            
            // Test if sections exist
            const sections = ['dashboard', 'query', 'analytics', 'advanced-analytics', 'employees', 'reports'];
            sections.forEach(section => {
                const element = document.getElementById(section);
                console.log(`Section ${section}:`, element ? 'Found' : 'Not found');
            });
            
            // Test if navigation items exist
            const navItems = document.querySelectorAll('.nav-item');
            console.log('Navigation items found:', navItems.length);
            
            // Initialize dashboard data loading
            setTimeout(async () => {
                console.log('Initializing dashboard data...');
                try {
                    // Load employee count
                    const response = await fetch('/api/employee-count');
                    const data = await response.json();
                    console.log('Employee count data:', data);
                    
                    const totalEmployeesElement = document.getElementById('totalEmployees');
                    if (totalEmployeesElement) {
                        totalEmployeesElement.textContent = data.count || 0;
                        console.log('Updated total employees to:', data.count);
                    }
                    
                    // Load department count
                    const deptResponse = await fetch('/api/analytics/departments');
                    const deptData = await deptResponse.json();
                    console.log('Department data:', deptData);
                    
                    const totalDepartmentsElement = document.getElementById('totalDepartments');
                    if (totalDepartmentsElement) {
                        totalDepartmentsElement.textContent = deptData.total_departments || 0;
                        console.log('Updated total departments to:', deptData.total_departments);
                    }
                    
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                }
            }, 1000);
            
            // Test advanced analytics endpoint
            setTimeout(async () => {
                try {
                    console.log('Testing advanced analytics endpoint...');
                    const response = await fetch('/api/analytics/executive-dashboard');
                    const data = await response.json();
                    console.log('Advanced analytics endpoint working:', data.timestamp ? 'Yes' : 'No');
                } catch (error) {
                    console.error('Advanced analytics endpoint error:', error);
                }
            }, 2000);
        });
        
        // Global test function for advanced analytics
        window.testAdvancedAnalytics = async function() {
            console.log('Testing advanced analytics loading...');
            try {
                const response = await fetch('/api/analytics/executive-dashboard');
                const data = await response.json();
                console.log('Executive Dashboard Data:', data);
                return data;
            } catch (error) {
                console.error('Error testing advanced analytics:', error);
                return null;
            }
        };
        
        // Direct function to load advanced analytics
        window.loadAdvancedAnalyticsDirect = async function() {
            console.log('Direct advanced analytics loading...');
            try {
                const analyticsContainer = document.getElementById('analyticsContent');
                if (!analyticsContainer) {
                    console.error('analyticsContent element not found');
                    return;
                }
                
                // Show loading state
                analyticsContainer.innerHTML = `
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading AI Analytics...</p>
                    </div>
                `;
                
                // Load all analytics endpoints
                console.log('Fetching advanced analytics data...');
                const [executiveDashboard, predictiveInsights, talentIntelligence, workforceOptimization, riskAssessment] = await Promise.all([
                    fetch('/api/analytics/executive-dashboard').then(r => r.json()),
                    fetch('/api/analytics/predictive-insights').then(r => r.json()),
                    fetch('/api/analytics/talent-intelligence').then(r => r.json()),
                    fetch('/api/analytics/workforce-optimization').then(r => r.json()),
                    fetch('/api/analytics/risk-assessment').then(r => r.json())
                ]);
                
                console.log('All analytics data fetched successfully');
                
                // Display the analytics
                analyticsContainer.innerHTML = `
                    <div class="advanced-analytics-grid">
                        <!-- Executive Dashboard -->
                        <div class="analytics-card executive-card">
                            <div class="card-header">
                                <h3><i class="fas fa-chart-line"></i> Executive Dashboard</h3>
                            </div>
                            <div class="card-content">
                                <div class="ai-insights">
                                    <h4>AI-Powered Insights</h4>
                                    <div class="insight-content">
                                        ${executiveDashboard.ai_insights?.analysis || 'Executive insights will be generated based on comprehensive workforce data analysis.'}
                                    </div>
                                </div>
                                <div class="recommendations">
                                    <h4>Strategic Recommendations</h4>
                                    <div class="recommendation-list">
                                        ${executiveDashboard.recommendations?.map(rec => `
                                            <div class="recommendation-item">
                                                <span class="rec-category">${rec.category}</span>
                                                <span class="rec-title">${rec.title}</span>
                                                <span class="rec-action">${rec.action}</span>
                                            </div>
                                        `).join('') || '<div class="recommendation-item"><span class="rec-category">Strategic</span><span class="rec-title">Data-Driven Insights</span><span class="rec-action">Continue monitoring workforce metrics</span></div>'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Predictive Insights -->
                        <div class="analytics-card predictive-card">
                            <div class="card-header">
                                <h3><i class="fas fa-crystal-ball"></i> Predictive Insights</h3>
                            </div>
                            <div class="card-content">
                                <div class="prediction-content">
                                    <div class="confidence-badge">
                                        ${predictiveInsights.confidence_level || 'High'} Confidence
                                    </div>
                                    <div class="ai-predictions">
                                        ${predictiveInsights.predictions ? predictiveInsights.predictions.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/\n/g, '<br>') : 'Predictive analysis will be generated based on current workforce trends and performance metrics.'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Talent Intelligence -->
                        <div class="analytics-card talent-card">
                            <div class="card-header">
                                <h3><i class="fas fa-brain"></i> Talent Intelligence</h3>
                            </div>
                            <div class="card-content">
                                <div class="talent-content">
                                    ${talentIntelligence.talent_intelligence ? talentIntelligence.talent_intelligence.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/\n/g, '<br>') : 'Talent intelligence analysis will be generated based on employee performance, engagement, and development metrics.'}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Workforce Optimization -->
                        <div class="analytics-card workforce-card">
                            <div class="card-header">
                                <h3><i class="fas fa-users-cog"></i> Workforce Optimization</h3>
                            </div>
                            <div class="card-content">
                                <div class="workforce-content">
                                    ${workforceOptimization.optimization_plan ? workforceOptimization.optimization_plan.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/\n/g, '<br>') : 'Workforce optimization recommendations will be generated based on current performance metrics and organizational goals.'}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Risk Assessment -->
                        <div class="analytics-card risk-card">
                            <div class="card-header">
                                <h3><i class="fas fa-exclamation-triangle"></i> Risk Assessment</h3>
                            </div>
                            <div class="card-content">
                                <div class="risk-content">
                                    ${riskAssessment.risk_assessment ? riskAssessment.risk_assessment.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/\n/g, '<br>') : 'Risk assessment will be generated based on current workforce metrics and organizational risk factors.'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                console.log('Advanced analytics displayed successfully');
                
            } catch (error) {
                console.error('Error loading advanced analytics:', error);
                const analyticsContainer = document.getElementById('analyticsContent');
                if (analyticsContainer) {
                    analyticsContainer.innerHTML = `
                        <div class="error-state">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>Error loading AI Analytics: ${error.message}</p>
                        </div>
                    `;
                }
            }
        };
        
        // Direct function to submit query
        window.submitQueryDirect = async function() {
            console.log('Direct query submission...');
            const queryInput = document.getElementById('queryInput');
            if (!queryInput) {
                console.error('Query input not found');
                return;
            }
            
            const query = queryInput.value.trim();
            if (!query) {
                alert('Please enter a query');
                return;
            }
            
            try {
                console.log('Submitting query:', query);
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        top_k: 5
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Query response:', data);
                
                // Display results
                const resultsContainer = document.getElementById('queryResults');
                if (resultsContainer) {
                    resultsContainer.innerHTML = `
                        <div class="query-response">
                            <div class="response-header">
                                <h3>AI Response</h3>
                                <span class="response-time">${data.response_time ? `(${data.response_time.toFixed(2)}s)` : ''}</span>
                            </div>
                            <div class="ai-response">
                                ${data.response || 'No response received'}
                            </div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error submitting query:', error);
                alert('Error submitting query: ' + error.message);
            }
        };
        
        // Override the submitQuery function
        window.submitQuery = window.submitQueryDirect;
        
        // Direct function to load employees with caching
        window.loadEmployeesDirect = async function() {
            console.log('Direct employees loading...');
            
            // Check cache first
            const cacheKey = 'employees_data';
            const cachedData = sessionStorage.getItem(cacheKey);
            const cacheTime = sessionStorage.getItem(cacheKey + '_time');
            const now = Date.now();
            
            // Use cached data if less than 5 minutes old
            if (cachedData && cacheTime && (now - parseInt(cacheTime)) < 300000) {
                console.log('Using cached employees data');
                const data = JSON.parse(cachedData);
                displayEmployees(data);
                return;
            }
            
            try {
                const response = await fetch('/api/employees?limit=20');
                const data = await response.json();
                console.log('Employees data:', data);
                
                // Cache the data
                sessionStorage.setItem(cacheKey, JSON.stringify(data));
                sessionStorage.setItem(cacheKey + '_time', now.toString());
                
                displayEmployees(data);
                
            } catch (error) {
                console.error('Error loading employees:', error);
                showErrorMessage('Unable to load employee directory', 
                    'There was a problem connecting to the employee database. Please try again or contact support if the issue persists.');
            }
        };
        
        // Optimized function to display employees
        function displayEmployees(data) {
            const employeesGrid = document.getElementById('employeesGrid');
            if (!employeesGrid) return;
            
            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            
            data.employees.forEach(employee => {
                        const employeeCard = document.createElement('div');
                        employeeCard.className = 'employee-card';
                        // Format performance rating with stars
                        const performanceRating = employee.performance_rating || 0;
                        const stars = '★'.repeat(Math.floor(performanceRating)) + '☆'.repeat(5 - Math.floor(performanceRating));
                        const performanceClass = performanceRating >= 4 ? 'high-performance' : performanceRating >= 3 ? 'medium-performance' : 'low-performance';
                        
                        // Format KPIs with percentage
                        const kpisValue = employee.kpis_met_pct || 0;
                        const kpisClass = kpisValue >= 80 ? 'high-kpis' : kpisValue >= 60 ? 'medium-kpis' : 'low-kpis';
                        
                        // Format salary with proper currency
                        const salaryValue = employee.current_salary ? `$${employee.current_salary.toLocaleString()}` : 'N/A';
                        
                        // Get department color
                        const departmentColors = {
                            'Marketing': '#e74c3c',
                            'IT': '#3498db', 
                            'HR': '#9b59b6',
                            'Finance': '#f39c12',
                            'Engineering': '#2ecc71',
                            'Sales': '#e67e22',
                            'Customer Success': '#1abc9c'
                        };
                        const deptColor = departmentColors[employee.department] || '#95a5a6';
                        
                        employeeCard.innerHTML = `
                            <div class="employee-card-header" style="border-left: 4px solid ${deptColor}">
                                <div class="employee-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="employee-title">
                                    <h3>${employee.full_name || 'N/A'}</h3>
                                    <p class="employee-role">${employee.role || 'N/A'}</p>
                                    <span class="employee-id">ID: ${employee.employee_id}</span>
                                </div>
                            </div>
                            
                            <div class="employee-metrics">
                                <div class="metric-item">
                                    <div class="metric-label">Department</div>
                                    <div class="metric-value department-badge" style="background-color: ${deptColor}20; color: ${deptColor}; border: 1px solid ${deptColor}40">
                                        ${employee.department || 'N/A'}
                                    </div>
                                </div>
                                
                                <div class="metric-item">
                                    <div class="metric-label">Performance</div>
                                    <div class="metric-value performance-stars ${performanceClass}">
                                        <span class="stars">${stars}</span>
                                        <span class="rating">${performanceRating}/5</span>
                                    </div>
                                </div>
                                
                                <div class="metric-item">
                                    <div class="metric-label">KPIs Met</div>
                                    <div class="metric-value kpis-percentage ${kpisClass}">
                                        <div class="kpis-bar">
                                            <div class="kpis-fill" style="width: ${kpisValue}%"></div>
                                        </div>
                                        <span class="kpis-text">${kpisValue}%</span>
                                    </div>
                                </div>
                                
                                <div class="metric-item">
                                    <div class="metric-label">Salary</div>
                                    <div class="metric-value salary-amount">
                                        ${salaryValue}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="employee-actions">
                                <button class="btn btn-primary btn-view" onclick="viewEmployeeDirect('${employee.employee_id}')">
                                    <i class="fas fa-eye"></i>
                                    <span>View Details</span>
                                </button>
                            </div>
                        `;
                        fragment.appendChild(employeeCard);
                    });
                    
                    // Clear and append all at once for better performance
                    employeesGrid.innerHTML = '';
                    employeesGrid.appendChild(fragment);
                    
                    console.log(`Loaded ${data.employees.length} employees`);
        }
        
        // Direct function to view employee
        window.viewEmployeeDirect = async function(employeeId) {
            console.log('Direct employee view for:', employeeId);
            try {
                const response = await fetch(`/api/employee/${employeeId}`);
                const employee = await response.json();
                console.log('Employee details:', employee);
                
                // Create modal
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Employee Details</h2>
                            <span class="close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="employee-detail-grid">
                                <div class="detail-section">
                                    <h3>Personal Information</h3>
                                    <div class="detail-row"><span class="label">Name:</span><span class="value">${employee.full_name || 'N/A'}</span></div>
                                    <div class="detail-row"><span class="label">Email:</span><span class="value">${employee.email || 'N/A'}</span></div>
                                    <div class="detail-row"><span class="label">Phone:</span><span class="value">${employee.contact_number || 'N/A'}</span></div>
                                    <div class="detail-row"><span class="label">Age:</span><span class="value">${employee.age || 'N/A'}</span></div>
                                    <div class="detail-row"><span class="label">Gender:</span><span class="value">${employee.gender || 'N/A'}</span></div>
                                    <div class="detail-row"><span class="label">Location:</span><span class="value">${employee.location || 'N/A'}</span></div>
                                </div>
                                <div class="detail-section">
                                    <h3>Employment Information</h3>
                                    <div class="detail-row"><span class="label">Department:</span><span class="value">${employee.department || 'N/A'}</span></div>
                                    <div class="detail-row"><span class="label">Role:</span><span class="value">${employee.role || 'N/A'}</span></div>
                                    <div class="detail-row"><span class="label">Grade/Band:</span><span class="value">${employee.grade_band || 'N/A'}</span></div>
                                    <div class="detail-row"><span class="label">Employment Type:</span><span class="value">${employee.employment_type || 'N/A'}</span></div>
                                    <div class="detail-row"><span class="label">Work Mode:</span><span class="value">${employee.work_mode || 'N/A'}</span></div>
                                    <div class="detail-row"><span class="label">Date of Joining:</span><span class="value">${employee.joining_date ? new Date(employee.joining_date).toLocaleDateString() : 'N/A'}</span></div>
                                </div>
                                <div class="detail-section">
                                    <h3>Performance & Compensation</h3>
                                    <div class="detail-row"><span class="label">Performance Rating:</span><span class="value">${employee.performance_rating || 'N/A'}/5</span></div>
                                    <div class="detail-row"><span class="label">KPIs Met:</span><span class="value">${employee.kpis_met_pct || 'N/A'}</span></div>
                                    <div class="detail-row"><span class="label">Current Salary:</span><span class="value">$${employee.current_salary ? employee.current_salary.toLocaleString() : 'N/A'}</span></div>
                                    <div class="detail-row"><span class="label">Awards:</span><span class="value">${employee.awards || 'None'}</span></div>
                                </div>
                                <div class="detail-section">
                                    <h3>Learning & Engagement</h3>
                                    <div class="detail-row"><span class="label">Courses Completed:</span><span class="value">${employee.courses_completed || 'N/A'}</span></div>
                                    <div class="detail-row"><span class="label">Certifications:</span><span class="value">${employee.certifications || 'None'}</span></div>
                                    <div class="detail-row"><span class="label">Engagement Score:</span><span class="value">${employee.engagement_score || 'N/A'}/5</span></div>
                                    <div class="detail-row"><span class="label">Attrition Risk:</span><span class="value">${employee.attrition_risk_score || 'N/A'}/10</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                modal.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading employee details:', error);
                showErrorMessage('Unable to load employee details', 
                    'We couldn\'t retrieve the complete information for this employee. The employee may not exist or there might be a temporary connection issue.');
            }
        };
        
        // Enhanced loading state functions
        window.showLoading = function(title = "Processing your request...", message = "Please wait while we analyze your data") {
            const overlay = document.getElementById('loadingOverlay');
            const titleEl = document.getElementById('loadingTitle');
            const messageEl = document.getElementById('loadingMessage');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            if (titleEl) titleEl.textContent = title;
            if (messageEl) messageEl.textContent = message;
            if (progressFill) progressFill.style.width = '0%';
            if (progressText) progressText.textContent = '0%';
            
            if (overlay) {
                overlay.classList.add('active');
                // Simulate progress
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress > 90) progress = 90;
                    if (progressFill) progressFill.style.width = progress + '%';
                    if (progressText) progressText.textContent = Math.round(progress) + '%';
                }, 200);
                
                // Store interval for cleanup
                overlay.dataset.progressInterval = interval;
            }
        };
        
        window.hideLoading = function() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                // Clear progress interval
                if (overlay.dataset.progressInterval) {
                    clearInterval(overlay.dataset.progressInterval);
                }
                
                // Complete progress bar
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                if (progressFill) progressFill.style.width = '100%';
                if (progressText) progressText.textContent = '100%';
                
                // Hide after a brief delay
                setTimeout(() => {
                    overlay.classList.remove('active');
                }, 300);
            }
        };
        
        window.updateLoadingProgress = function(progress, message = null) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const messageEl = document.getElementById('loadingMessage');
            
            if (progressFill) progressFill.style.width = progress + '%';
            if (progressText) progressText.textContent = Math.round(progress) + '%';
            if (messageEl && message) messageEl.textContent = message;
        };
        
        // Enhanced error message function
        window.showErrorMessage = function(title, message, type = 'error') {
            // Create error modal
            const errorModal = document.createElement('div');
            errorModal.className = 'error-modal';
            errorModal.innerHTML = `
                <div class="error-modal-content">
                    <div class="error-header">
                        <div class="error-icon ${type}">
                            <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
                        </div>
                        <h3>${title}</h3>
                        <button class="error-close" onclick="this.parentElement.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="error-body">
                        <p>${message}</p>
                        <div class="error-actions">
                            <button class="btn btn-primary" onclick="this.parentElement.parentElement.parentElement.remove()">
                                <i class="fas fa-check"></i>
                                Got it
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(errorModal);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (errorModal.parentElement) {
                    errorModal.remove();
                }
            }, 10000);
        };
        
        // Success message function
        window.showSuccessMessage = function(title, message) {
            showErrorMessage(title, message, 'success');
        };
        
        // Warning message function
        window.showWarningMessage = function(title, message) {
            showErrorMessage(title, message, 'warning');
        };

        // Function to generate reports
        window.generateReport = async function(reportType) {
            console.log('Generating report:', reportType);
            
            try {
                let reportData = {};
                let reportTitle = '';
                let reportContent = '';
                
                switch (reportType) {
                    case 'employee-summary':
                        reportTitle = 'Employee Summary Report';
                        const empResponse = await fetch('/api/employees?limit=100');
                        const empData = await empResponse.json();
                        reportData = empData;
                        reportContent = `
                            <h2>Employee Summary Report</h2>
                            <p><strong>Total Employees:</strong> ${empData.employees.length}</p>
                            <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                            <h3>Employee List:</h3>
                            <table border="1" style="width: 100%; border-collapse: collapse;">
                                <tr>
                                    <th>Employee ID</th>
                                    <th>Name</th>
                                    <th>Department</th>
                                    <th>Role</th>
                                    <th>Performance Rating</th>
                                </tr>
                                ${empData.employees.map(emp => `
                                    <tr>
                                        <td>${emp.employee_id}</td>
                                        <td>${emp.first_name} ${emp.last_name}</td>
                                        <td>${emp.department || 'N/A'}</td>
                                        <td>${emp.role || 'N/A'}</td>
                                        <td>${emp.performance_rating || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </table>
                        `;
                        break;
                        
                    case 'performance':
                        reportTitle = 'Performance Report';
                        const perfResponse = await fetch('/api/analytics/performance');
                        const perfData = await perfResponse.json();
                        reportData = perfData;
                        reportContent = `
                            <h2>Performance Report</h2>
                            <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                            <h3>Performance Metrics:</h3>
                            <ul>
                                <li><strong>Total Employees:</strong> ${perfData.total_employees}</li>
                                <li><strong>Average Performance:</strong> ${perfData.avg_performance}/5</li>
                                <li><strong>High Performers:</strong> ${perfData.high_performers} (${perfData.high_performer_pct}%)</li>
                                <li><strong>Low Performers:</strong> ${perfData.low_performers} (${perfData.low_performer_pct}%)</li>
                                <li><strong>Average KPIs Met:</strong> ${perfData.avg_kpis}%</li>
                                <li><strong>Performance Range:</strong> ${perfData.min_performance} - ${perfData.max_performance}</li>
                            </ul>
                        `;
                        break;
                        
                    case 'compensation':
                        reportTitle = 'Compensation Report';
                        const compResponse = await fetch('/api/analytics/salary');
                        const compData = await compResponse.json();
                        reportData = compData;
                        reportContent = `
                            <h2>Compensation Report</h2>
                            <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                            <h3>Salary Metrics:</h3>
                            <ul>
                                <li><strong>Total Employees:</strong> ${compData.total_employees}</li>
                                <li><strong>Average Salary:</strong> $${compData.avg_salary.toLocaleString()}</li>
                                <li><strong>Minimum Salary:</strong> $${compData.min_salary.toLocaleString()}</li>
                                <li><strong>Maximum Salary:</strong> $${compData.max_salary.toLocaleString()}</li>
                                <li><strong>Salary Range:</strong> $${compData.salary_range.toLocaleString()}</li>
                            </ul>
                            <h3>Department Salary Breakdown:</h3>
                            <table border="1" style="width: 100%; border-collapse: collapse;">
                                <tr>
                                    <th>Department</th>
                                    <th>Employee Count</th>
                                    <th>Average Salary</th>
                                    <th>Min Salary</th>
                                    <th>Max Salary</th>
                                </tr>
                                ${compData.department_analytics.map(dept => `
                                    <tr>
                                        <td>${dept.department}</td>
                                        <td>${dept.employee_count}</td>
                                        <td>$${dept.avg_salary.toLocaleString()}</td>
                                        <td>$${dept.min_salary.toLocaleString()}</td>
                                        <td>$${dept.max_salary.toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </table>
                        `;
                        break;
                }
                
                // Create and display report
                const reportWindow = window.open('', '_blank');
                reportWindow.document.write(`
                    <html>
                        <head>
                            <title>${reportTitle}</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 20px; }
                                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                                th { background-color: #f2f2f2; }
                            </style>
                        </head>
                        <body>
                            ${reportContent}
                        </body>
                    </html>
                `);
                reportWindow.document.close();
                
                console.log('Report generated successfully:', reportType);
                
            } catch (error) {
                console.error('Error generating report:', error);
                alert('Error generating report: ' + error.message);
            }
        };
    </script>
</body>
</html>